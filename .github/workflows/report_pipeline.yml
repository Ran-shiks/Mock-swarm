name: CI Pipeline Report

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov coverage behave junit-xml

      - name: Generate timestamp
        id: timestamp
        run: echo "time=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Add src to PYTHONPATH
        run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)/src" >> $GITHUB_ENV

      - name: Run Tests
        run: |
          mkdir -p reports/${{ env.time }}/pytest reports/${{ env.time }}/behave
          pytest tests/ \
            --junitxml=reports/${{ env.time }}/pytest/pytest-report.xml \
            --cov=src \
            --cov-report=html:reports/${{ env.time }}/coverage_html \
            --disable-warnings -q

          behave features/ \
            --junit -o reports/${{ env.time }}/behave/behave-report.xml \
            -f html -o reports/${{ env.time }}/behave/behave_report.html
        continue-on-error: true

      - name: Upload Test Reports (Artifacts)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ env.time }}
          path: reports/${{ env.time }}
          retention-days: 7

  deploy-to-gh-pages:
    needs: build-and-test
    if: needs.build-and-test.result == 'success' && github.ref == 'refs/heads/main'

    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-reports-${{ env.time }}
          path: ./reports

      - name: Prepare Pages Directory
        run: |
          mkdir -p ./gh-pages-site
          if [ -d "reports/coverage_html" ]; then
            mv reports/coverage_html ./gh-pages-site/coverage
          fi
          if [ -f "reports/behave/behave_report.html" ]; then
            mv reports/behave/behave_report.html ./gh-pages-site/behave_report.html
          fi
          echo '<html><head><title>Test Reports</title><meta charset="UTF-8"></head><body style="font-family:sans-serif;padding:20px;"><h1>Test Reports</h1><ul><li><a href="behave_report.html">Behave Test Report</a></li><li><a href="coverage/index.html">Pytest Coverage Report</a></li></ul></body></html>' > ./gh-pages-site/index.html

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./gh-pages-site
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
